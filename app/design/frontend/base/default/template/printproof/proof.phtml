<?php
    $proofs = Mage::helper('printproof')->getProofsForOrder();
    if ($proofs->count()):
?>
    <h2 class="margin-top-large"><?php echo $this->__('Printing Proofs') ?></h2>
    <?php foreach ($proofs as $proof): ?>
        <div class="printproof">
            <div class="printproof-status">
                <?php echo Mage::helper('printproof')->__('Status') ?>: <strong><?php echo $proof->getStatus() ?></strong>
            </div>
            <?php if (!$proof->getApproved() && !$proof->getRejected()): ?>
                <form id="printproof_reply_<?php echo $proof->getId() ?>" action="<?php echo $proof->getReplyUrl() ?>" method="POST" enctype="multipart/form-data" class="printproof-reply-form">
                    <input type="hidden" name="proof_id" value="<?php echo $proof->getId() ?>"/>
                    <input type="hidden" name="form_key" value="<?php echo Mage::getSingleton('core/session')->getFormKey() ?>"/>
                    <ul class="form-list">
                        <li class="wide">
                            <textarea name="comment" id="comment_<?php echo $proof->getId() ?>" class="textarea required-entry" style="width: 100%"></textarea>
                        </li>
                        <li class="wide">
                            <input type="file" name="attachment_<?php echo $proof->getId() ?>" />                    
                        </li>
                    </ul>
                    <button type="submit" class="button"><?php echo Mage::helper('printproof')->__('Reply') ?></button>
                </form>
                <div class="printproof-buttons">
                    <a class="button button-reject" href="<?php echo $proof->getRejectUrl() ?>">
                        <?php echo Mage::helper('printproof')->__('Reject') ?>
                    </a>
                    <a class="button button-approve" href="<?php echo $proof->getApprovalUrl() ?>">
                        <?php echo Mage::helper('printproof')->__('Approve') ?>
                    </a>
                </div>
            <?php endif; ?>
            <?php foreach ($proof->getCommentList() as $comment): ?>
                <div class="printproof-comment">
                    <p>
                        <strong><?php echo $comment->getName() ?></strong><br/>
                        <em><?php echo $comment->getDate() ?></em>
                    </p>
                    <p><?php echo $comment->getComment() ?></p>
                    <?php if ($comment->getAttachmentUrl()): ?>
                        <a href="<?php echo $comment->getAttachmentUrl() ?>">
                            <img src="<?php echo $comment->getAttachmentUrl() ?>" alt="Attachment">
                        </a>
                    <?php endif; ?>
                </div>
            <?php endforeach; ?>
            <script>
                new VarienForm('printproof_reply_<?php echo $proof->getId() ?>');
            </script>
        </div>
    <?php endforeach; ?>
<?php
    endif;
?>
<script type="text/javascript">
    $$('.button-reject').invoke('observe', 'click', function(e){
        if (!window.confirm('Are you sure you want to reject this proof?')){
            e.preventDefault();
            return false;
        }
    });
    $$('.button-approve').invoke('observe', 'click', function(e){
        if (!window.confirm('Are you sure you want to accept this proof?')){
            e.preventDefault();
            return false;
        }
    });
</script>